<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Stock Â· La Bolsa de CafÃ©</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,300;0,400;0,600;1,300&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* â”€â”€ Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg:        #F5EFE6;
  --surface:   #FDF9F4;
  --border:    #E8DDD2;
  --espresso:  #1A0F0A;
  --roast:     #3B1F12;
  --caramel:   #C07D3A;
  --latte:     #D4B896;
  --muted:     #8A7060;
  --text:      #241208;
  --ok:        #2E6B3A;
  --ok-bg:     #EAF4EC;
  --ok-bar:    #4CAF6A;
  --low:       #B85C00;
  --low-bg:    #FFF0E0;
  --low-bar:   #F5871F;
  --crit:      #A01515;
  --crit-bg:   #FDEAEA;
  --crit-bar:  #E53535;
  --sidebar-w: 240px;
  --header-h:  64px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 15px; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.layout { display: flex; min-height: 100vh; }

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
  width: var(--sidebar-w);
  background: var(--espresso);
  display: flex; flex-direction: column;
  position: fixed; top: 0; left: 0; bottom: 0;
  z-index: 200;
  transition: transform 0.3s ease;
}
.sidebar-logo {
  padding: 24px 20px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.logo-mark {
  width: 38px; height: 38px; border-radius: 10px;
  background: var(--caramel);
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; margin-bottom: 12px;
}
.logo-name {
  font-family: 'Fraunces', serif;
  font-size: 15px; color: #fff;
  line-height: 1.2; letter-spacing: 0.01em;
}
.logo-sub {
  font-size: 10px; color: var(--latte);
  letter-spacing: 0.08em; text-transform: uppercase;
  margin-top: 2px;
}
.sidebar-nav { padding: 16px 12px; flex: 1; }
.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; border-radius: 8px;
  cursor: pointer; transition: background 0.15s;
  font-size: 13px; color: rgba(255,255,255,0.55);
  font-weight: 400; margin-bottom: 2px;
  border: none; background: none; width: 100%; text-align: left;
}
.nav-item:hover { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.85); }
.nav-item.active { background: rgba(255,255,255,0.1); color: #fff; font-weight: 500; }
.nav-icon { font-size: 15px; width: 20px; text-align: center; }
.sidebar-footer {
  padding: 16px 12px;
  border-top: 1px solid rgba(255,255,255,0.08);
}
.sync-status {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 12px; border-radius: 8px;
  background: rgba(255,255,255,0.05);
  font-size: 11px; color: rgba(255,255,255,0.45);
}
.sync-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--caramel); flex-shrink: 0; }
.sync-dot.live { animation: blink 2s ease-in-out infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
.sync-text { flex: 1; line-height: 1.3; }
.sync-refresh {
  background: none; border: none; cursor: pointer;
  color: rgba(255,255,255,0.3); font-size: 13px;
  transition: color 0.2s; padding: 2px;
}
.sync-refresh:hover { color: rgba(255,255,255,0.7); }
.sync-refresh.spinning { animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main {
  margin-left: var(--sidebar-w);
  flex: 1; min-width: 0;
  display: flex; flex-direction: column;
}

/* â”€â”€ Top bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar {
  height: var(--header-h);
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 28px;
  position: sticky; top: 0; z-index: 100;
}
.topbar-left { display: flex; align-items: center; gap: 16px; }
.page-title {
  font-family: 'Fraunces', serif;
  font-size: 20px; font-weight: 300; color: var(--text);
}
.date-badge {
  font-size: 12px; color: var(--muted);
  background: var(--bg); border: 1px solid var(--border);
  padding: 4px 10px; border-radius: 20px;
}
.topbar-right { display: flex; align-items: center; gap: 10px; }

/* Mobile menu btn */
.menu-btn {
  display: none;
  background: none; border: none; cursor: pointer;
  font-size: 20px; color: var(--text); padding: 4px;
}

/* â”€â”€ Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.content { padding: 24px 28px; }

/* â”€â”€ KPI Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kpi-row {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 14px; margin-bottom: 24px;
}
.kpi-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px; padding: 18px 20px;
}
.kpi-label {
  font-size: 10px; font-weight: 600; letter-spacing: 0.08em;
  text-transform: uppercase; color: var(--muted); margin-bottom: 8px;
}
.kpi-value {
  font-family: 'Fraunces', serif;
  font-size: 28px; font-weight: 300; line-height: 1;
  color: var(--text);
}
.kpi-value.crit { color: var(--crit); }
.kpi-value.ok   { color: var(--ok); }
.kpi-sub { font-size: 11px; color: var(--muted); margin-top: 5px; }

/* â”€â”€ Section header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-head {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px;
}
.section-title {
  font-family: 'Fraunces', serif;
  font-size: 16px; font-weight: 300; color: var(--text);
}

/* â”€â”€ Filter tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.filter-tabs {
  display: flex; gap: 6px;
  flex-wrap: wrap;
}
.tab {
  padding: 5px 14px; border-radius: 20px;
  font-size: 12px; font-weight: 500; cursor: pointer;
  border: 1px solid var(--border);
  background: var(--surface); color: var(--muted);
  transition: all 0.15s;
}
.tab:hover { border-color: var(--caramel); color: var(--caramel); }
.tab.active {
  background: var(--espresso); color: #fff;
  border-color: var(--espresso);
}

/* â”€â”€ Alerts strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alerts-strip { margin-bottom: 20px; display: flex; flex-direction: column; gap: 8px; }
.alert-item {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 16px; border-radius: 10px;
  animation: fadeIn 0.3s ease;
}
.alert-item.critico { background: var(--crit-bg); border: 1px solid rgba(160,21,21,0.15); }
.alert-item.bajo    { background: var(--low-bg);  border: 1px solid rgba(184,92,0,0.15);  }
.alert-emoji { font-size: 16px; }
.alert-text { font-size: 13px; }
.alert-text strong { font-weight: 600; }
.alert-item.critico .alert-text { color: var(--crit); }
.alert-item.bajo    .alert-text { color: var(--low);  }

/* â”€â”€ Inventory table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.inv-table {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px; overflow: hidden;
}
.inv-row {
  display: grid;
  grid-template-columns: 1fr 130px 180px 90px;
  align-items: center;
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  transition: background 0.1s;
  animation: fadeIn 0.3s ease both;
}
.inv-row:last-child { border-bottom: none; }
.inv-row:hover { background: var(--bg); }
.inv-row.header {
  padding: 10px 20px;
  background: var(--bg);
  animation: none;
}
.inv-row.header:hover { background: var(--bg); }
.col-label {
  font-size: 10px; font-weight: 600;
  letter-spacing: 0.08em; text-transform: uppercase;
  color: var(--muted);
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Product info */
.prod-info { display: flex; align-items: center; gap: 12px; }
.prod-icon {
  width: 34px; height: 34px; border-radius: 9px;
  background: var(--bg); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; flex-shrink: 0;
}
.prod-name { font-size: 14px; font-weight: 500; line-height: 1.2; }
.prod-sku  { font-size: 11px; color: var(--muted); margin-top: 1px; }

/* Stock value */
.stock-val {
  font-family: 'Fraunces', serif;
  font-size: 18px; font-weight: 300;
  text-align: right;
}
.stock-val .unit { font-size: 11px; color: var(--muted); font-family: 'DM Sans', sans-serif; margin-left: 2px; }

/* Bar */
.bar-wrap { padding: 0 8px; }
.bar-track {
  height: 5px; background: var(--border); border-radius: 99px; overflow: hidden;
}
.bar-fill {
  height: 100%; border-radius: 99px;
  transition: width 0.8s cubic-bezier(.4,0,.2,1);
}
.bar-fill.ok     { background: var(--ok-bar); }
.bar-fill.bajo   { background: var(--low-bar); }
.bar-fill.critico {
  background: var(--crit-bar);
  animation: pulse-bar 2s ease-in-out infinite;
}
@keyframes pulse-bar { 0%,100%{opacity:1} 50%{opacity:0.5} }

/* Badge */
.badge {
  display: inline-flex; align-items: center; justify-content: center;
  padding: 3px 10px; border-radius: 20px;
  font-size: 11px; font-weight: 600; letter-spacing: 0.03em;
  white-space: nowrap;
}
.badge.ok     { background: var(--ok-bg);   color: var(--ok);   }
.badge.bajo   { background: var(--low-bg);  color: var(--low);  }
.badge.critico{ background: var(--crit-bg); color: var(--crit); }

/* â”€â”€ Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.4); z-index: 150;
}
.overlay.show { display: block; }

/* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty {
  padding: 48px; text-align: center;
  color: var(--muted); font-size: 13px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” Mobile
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {
  .sidebar {
    transform: translateX(-100%);
  }
  .sidebar.open {
    transform: translateX(0);
    box-shadow: 4px 0 20px rgba(0,0,0,0.3);
  }
  .main { margin-left: 0; }
  .menu-btn { display: block; }
  .topbar { padding: 0 16px; }
  .page-title { font-size: 17px; }
  .content { padding: 16px; }
  .kpi-row { grid-template-columns: repeat(3, 1fr); gap: 10px; }
  .kpi-card { padding: 14px 12px; }
  .kpi-value { font-size: 22px; }
  .inv-row {
    grid-template-columns: 1fr 80px;
    grid-template-rows: auto auto;
    gap: 8px;
    padding: 12px 14px;
  }
  .inv-row.header { display: none; }
  .col-stock { grid-column: 2; grid-row: 1; text-align: right; }
  .col-bar   { grid-column: 1 / -1; grid-row: 2; padding: 0; }
  .col-badge { display: none; }
  .bar-track { height: 4px; }
}

@media (max-width: 480px) {
  .kpi-value { font-size: 18px; }
  .kpi-label { font-size: 9px; }
  .filter-tabs { gap: 4px; }
  .tab { padding: 4px 10px; font-size: 11px; }
}
</style>
</head>
<body>

<div class="overlay" id="overlay" onclick="closeSidebar()"></div>

<div class="layout">

  <!-- â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-mark">â˜•</div>
      <div class="logo-name">La Bolsa de CafÃ©</div>
      <div class="logo-sub">Olivos Â· Buenos Aires</div>
    </div>

    <nav class="sidebar-nav">
      <button class="nav-item active" onclick="showView('dashboard')">
        <span class="nav-icon">â–¦</span> Panel General
      </button>
      <button class="nav-item" onclick="showView('inventario')">
        <span class="nav-icon">â—«</span> Inventario
      </button>
    </nav>

    <div class="sidebar-footer">
      <div class="sync-status">
        <div class="sync-dot live" id="syncDot"></div>
        <div class="sync-text" id="syncText">Conectando...</div>
        <button class="sync-refresh" id="syncBtn" onclick="loadData()" title="Actualizar">â†»</button>
      </div>
    </div>
  </aside>

  <!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="main">

    <!-- Topbar -->
    <header class="topbar">
      <div class="topbar-left">
        <button class="menu-btn" onclick="openSidebar()">â˜°</button>
        <h1 class="page-title" id="pageTitle">Panel General</h1>
        <div class="date-badge" id="dateBadge">â€”</div>
      </div>
    </header>

    <!-- Content -->
    <div class="content">

      <!-- â”€â”€ VIEW: DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="view-dashboard">

        <!-- KPIs -->
        <div class="kpi-row">
          <div class="kpi-card">
            <div class="kpi-label">Productos</div>
            <div class="kpi-value" id="kpi-total">â€”</div>
            <div class="kpi-sub">en seguimiento</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Alertas crÃ­ticas</div>
            <div class="kpi-value crit" id="kpi-criticos">â€”</div>
            <div class="kpi-sub" id="kpi-criticos-sub">productos</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Stock bajo</div>
            <div class="kpi-value" id="kpi-bajos">â€”</div>
            <div class="kpi-sub">cerca del mÃ­nimo</div>
          </div>
        </div>

        <!-- Alerts strip -->
        <div class="alerts-strip" id="alertsStrip"></div>

        <!-- Quick inventory -->
        <div class="section-head">
          <div class="section-title">Stock actual</div>
          <div class="filter-tabs" id="filterTabs">
            <button class="tab active" data-cat="TODOS" onclick="setFilter('TODOS', this)">Todos</button>
            <button class="tab" data-cat="CAFE" onclick="setFilter('CAFE', this)">CafÃ©s</button>
            <button class="tab" data-cat="CAPSULA" onclick="setFilter('CAPSULA', this)">CÃ¡psulas</button>
            <button class="tab" data-cat="TE" onclick="setFilter('TE', this)">TÃ©s</button>
          </div>
        </div>

        <div class="inv-table">
          <div class="inv-row header">
            <div class="col-label">Producto</div>
            <div class="col-label" style="text-align:right">Stock</div>
            <div class="col-label" style="padding:0 8px">Nivel</div>
            <div class="col-label">Estado</div>
          </div>
          <div id="invRows"></div>
        </div>

      </div><!-- /dashboard -->

      <!-- â”€â”€ VIEW: INVENTARIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="view-inventario" style="display:none">
        <div class="section-head">
          <div class="section-title">Inventario completo</div>
          <div class="filter-tabs" id="filterTabs2">
            <button class="tab active" data-cat="TODOS" onclick="setFilter2('TODOS', this)">Todos</button>
            <button class="tab" data-cat="CAFE" onclick="setFilter2('CAFE', this)">CafÃ©s</button>
            <button class="tab" data-cat="CAPSULA" onclick="setFilter2('CAPSULA', this)">CÃ¡psulas</button>
            <button class="tab" data-cat="TE" onclick="setFilter2('TE', this)">TÃ©s</button>
          </div>
        </div>
        <div class="inv-table">
          <div class="inv-row header">
            <div class="col-label">Producto</div>
            <div class="col-label" style="text-align:right">Stock actual</div>
            <div class="col-label" style="padding:0 8px">Nivel</div>
            <div class="col-label">Estado</div>
          </div>
          <div id="invRows2"></div>
        </div>
      </div><!-- /inventario -->

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /layout -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRffHwJ6ENflfqZ54m0ehIjqAaJt5X-5-WCByHPuknvCzdbENe7hxMkL1DI2XWunZArFdmaDLg27VGE/pub?gid=1435082045&single=true&output=csv";
const REFRESH_MS = 5 * 60 * 1000;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allProducts = [];
let currentFilter = 'TODOS';
let currentFilter2 = 'TODOS';

// â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSidebar() {
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('overlay').classList.add('show');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('overlay').classList.remove('show');
}

// â”€â”€ Views â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showView(name) {
  ['dashboard','inventario'].forEach(v => {
    document.getElementById('view-' + v).style.display = v === name ? '' : 'none';
  });
  document.querySelectorAll('.nav-item').forEach((btn, i) => {
    btn.classList.toggle('active', ['dashboard','inventario'][i] === name);
  });
  const titles = { dashboard: 'Panel General', inventario: 'Inventario' };
  document.getElementById('pageTitle').textContent = titles[name];
  closeSidebar();
  if (name === 'inventario') renderInv2();
}

// â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setFilter(cat, btn) {
  currentFilter = cat;
  document.querySelectorAll('#filterTabs .tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderInv();
}
function setFilter2(cat, btn) {
  currentFilter2 = cat;
  document.querySelectorAll('#filterTabs2 .tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderInv2();
}

// â”€â”€ Parse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseCSV(csv) {
  const lines = csv.trim().split('\n');
  const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
  return lines.slice(1).map(line => {
    const vals = []; let cur = '', inQ = false;
    for (const ch of line) {
      if (ch === '"') { inQ = !inQ; }
      else if (ch === ',' && !inQ) { vals.push(cur.trim()); cur = ''; }
      else cur += ch;
    }
    vals.push(cur.trim());
    const obj = {};
    headers.forEach((h, i) => obj[h] = (vals[i] || '').replace(/"/g, ''));
    return obj;
  }).filter(r => r.SKU && r.SKU.trim() !== '');
}

function inferTipo(sku) {
  if (sku.startsWith('CAPS_')) return 'CAPSULA';
  if (sku.startsWith('TE_'))   return 'TE';
  return 'CAFE';
}

function parseEstado(s) {
  const u = (s || '').toUpperCase();
  if (u.includes('CRITICO') || u.includes('CRÃTICO')) return 'critico';
  if (u.includes('BAJO')) return 'bajo';
  return 'ok';
}

function rowToProduct(r) {
  const tipo = inferTipo(r.SKU);
  const emoji = tipo === 'CAFE' ? 'â˜•' : tipo === 'CAPSULA' ? 'âš«' : 'ğŸ«–';
  const unidad = tipo === 'CAFE' ? 'kg' : 'u';
  let stockActual = parseFloat((r.Stock_Actual || '0').replace(',', '.')) || 0;
  let stockMin    = parseFloat((r.Stock_Minimo  || '0').replace(',', '.')) || 0;
  if (tipo === 'CAFE') { stockActual /= 1000; stockMin /= 1000; }
  const stockObj = Math.max(stockMin * 3, 0.01);
  const estado = parseEstado(r.Estado);
  return {
    sku: r.SKU,
    nombre: (r.Nombre_Producto || r.SKU).trim(),
    tipo, emoji, unidad, stockActual, stockMin, stockObj, estado
  };
}

// â”€â”€ Render helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtStock(val, unit) {
  if (unit === 'kg') return val < 1 ? (val * 1000).toFixed(0) : val.toFixed(2);
  return val.toFixed(0);
}
function fmtUnit(val, unit) {
  return unit === 'kg' ? (val < 1 ? 'g' : 'kg') : unit;
}
function barPct(actual, obj) {
  return Math.min(100, Math.round((actual / obj) * 100));
}
function estadoLabel(e) {
  return { ok: 'OK', bajo: 'Bajo', critico: 'CrÃ­tico' }[e] || e;
}

function makeRow(p, delay) {
  const pct = barPct(p.stockActual, p.stockObj);
  const val = fmtStock(p.stockActual, p.unidad);
  const unit = fmtUnit(p.stockActual, p.unidad);
  const minStr = p.unidad === 'kg'
    ? (p.stockMin < 1 ? `${(p.stockMin*1000).toFixed(0)}g` : `${p.stockMin.toFixed(2)}kg`)
    : `${p.stockMin.toFixed(0)} ${p.unidad}`;

  return `
    <div class="inv-row" style="animation-delay:${delay}s">
      <div class="prod-info">
        <div class="prod-icon">${p.emoji}</div>
        <div>
          <div class="prod-name">${p.nombre}</div>
          <div class="prod-sku">${p.sku}</div>
        </div>
      </div>
      <div class="stock-val col-stock">
        ${val}<span class="unit">${unit}</span>
      </div>
      <div class="bar-wrap col-bar">
        <div class="bar-track">
          <div class="bar-fill ${p.estado}" style="width:${pct}%"></div>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:3px">MÃ­n: ${minStr}</div>
      </div>
      <div class="col-badge">
        <span class="badge ${p.estado}">${estadoLabel(p.estado)}</span>
      </div>
    </div>`;
}

// â”€â”€ Render views â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderInv() {
  const filtered = currentFilter === 'TODOS'
    ? allProducts
    : allProducts.filter(p => p.tipo === currentFilter);
  const html = filtered.length
    ? filtered.map((p, i) => makeRow(p, i * 0.04)).join('')
    : '<div class="empty">No hay productos en esta categorÃ­a.</div>';
  document.getElementById('invRows').innerHTML = html;
}

function renderInv2() {
  const filtered = currentFilter2 === 'TODOS'
    ? allProducts
    : allProducts.filter(p => p.tipo === currentFilter2);
  const html = filtered.length
    ? filtered.map((p, i) => makeRow(p, i * 0.04)).join('')
    : '<div class="empty">No hay productos en esta categorÃ­a.</div>';
  document.getElementById('invRows2').innerHTML = html;
}

function renderAlerts() {
  const criticos = allProducts.filter(p => p.estado === 'critico');
  const bajos    = allProducts.filter(p => p.estado === 'bajo');
  let html = '';
  criticos.forEach(p => {
    const def = Math.max(0, p.stockMin - p.stockActual);
    const defStr = p.unidad === 'kg'
      ? (def < 0.1 ? `${(def*1000).toFixed(0)}g` : `${def.toFixed(2)}kg`)
      : `${def.toFixed(0)} ${p.unidad}`;
    html += `<div class="alert-item critico">
      <span class="alert-emoji">âš ï¸</span>
      <span class="alert-text"><strong>${p.nombre}</strong> â€” Faltan ${defStr} para el mÃ­nimo Â· Hacer pedido urgente</span>
    </div>`;
  });
  bajos.forEach(p => {
    html += `<div class="alert-item bajo">
      <span class="alert-emoji">âš¡</span>
      <span class="alert-text"><strong>${p.nombre}</strong> â€” Cerca del mÃ­nimo Â· Incluir en prÃ³ximo pedido</span>
    </div>`;
  });
  document.getElementById('alertsStrip').innerHTML = html;
}

function renderKPIs() {
  const criticos = allProducts.filter(p => p.estado === 'critico').length;
  const bajos    = allProducts.filter(p => p.estado === 'bajo').length;
  document.getElementById('kpi-total').textContent     = allProducts.length;
  document.getElementById('kpi-criticos').textContent  = criticos;
  document.getElementById('kpi-bajos').textContent     = bajos;
  document.getElementById('kpi-criticos-sub').textContent = criticos === 1 ? 'producto' : 'productos';
  // Color KPI crÃ­ticos
  const el = document.getElementById('kpi-criticos');
  el.className = 'kpi-value ' + (criticos > 0 ? 'crit' : 'ok');
}

// â”€â”€ Load data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  const btn = document.getElementById('syncBtn');
  btn.classList.add('spinning');
  document.getElementById('syncText').textContent = 'Actualizando...';

  try {
    const resp = await fetch(SHEET_CSV_URL + '&t=' + Date.now());
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const csv = await resp.text();
    const rows = parseCSV(csv);
    allProducts = rows.map(rowToProduct);

    renderKPIs();
    renderAlerts();
    renderInv();

    const now = new Date();
    const timeStr = now.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
    const dateStr = now.toLocaleDateString('es-AR', { day: 'numeric', month: 'short', year: 'numeric' });
    document.getElementById('dateBadge').textContent = dateStr;
    document.getElementById('syncText').textContent = 'Actualizado ' + timeStr;
    document.getElementById('syncDot').classList.add('live');

  } catch (err) {
    console.error(err);
    document.getElementById('syncText').textContent = 'Error al conectar';
    document.getElementById('syncDot').classList.remove('live');
  } finally {
    btn.classList.remove('spinning');
  }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadData();
setInterval(loadData, REFRESH_MS);
</script>
</body>
</html>
