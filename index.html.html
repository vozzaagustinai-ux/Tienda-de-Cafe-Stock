<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Stock Â· La Bolsa de CafÃ©</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  /* â”€â”€ Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  :root {
    --espresso:   #1C0F0A;
    --roast:      #3D1F14;
    --mahogany:   #6B3728;
    --caramel:    #C4813A;
    --latte:      #E8C99A;
    --cream:      #F7F0E6;
    --milk:       #FDF9F4;
    --ok:         #2E7D32;
    --ok-bg:      #E8F5E9;
    --low:        #E65100;
    --low-bg:     #FFF3E0;
    --crit:       #B71C1C;
    --crit-bg:    #FFEBEE;
    --crit-pulse: #EF5350;
    --text:       #2A1810;
    --muted:      #8D6E63;
    --border:     #EDE0D4;
    --radius:     14px;
    --radius-sm:  8px;
  }

  /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { font-size: 16px; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--cream);
    color: var(--text);
    min-height: 100vh;
    padding-bottom: env(safe-area-inset-bottom, 24px);
  }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header {
    background: var(--espresso);
    padding: 20px 20px 24px;
    padding-top: max(20px, env(safe-area-inset-top, 20px));
    position: sticky; top: 0; z-index: 100;
  }
  .header-top {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 4px;
  }
  .brand {
    display: flex; align-items: center; gap: 10px;
  }
  .brand-icon {
    width: 36px; height: 36px; border-radius: 10px;
    background: var(--caramel);
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
  }
  .brand-name {
    font-family: 'DM Serif Display', serif;
    font-size: 17px; color: var(--cream); letter-spacing: 0.01em;
    line-height: 1.2;
  }
  .brand-sub {
    font-size: 11px; color: var(--latte); font-weight: 300; letter-spacing: 0.04em;
  }
  .refresh-btn {
    background: rgba(255,255,255,0.1); border: none; border-radius: 50%;
    width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: background 0.2s;
    color: var(--latte); font-size: 16px;
  }
  .refresh-btn:active { background: rgba(255,255,255,0.2); }
  .refresh-btn.spinning svg { animation: spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .header-meta {
    display: flex; align-items: center; gap: 6px;
    font-size: 11px; color: var(--latte); font-weight: 300;
  }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--caramel); }
  .dot.live { animation: pulse-dot 2s ease-in-out infinite; }
  @keyframes pulse-dot {
    0%, 100% { opacity: 1; } 50% { opacity: 0.3; }
  }

  /* â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  main { padding: 16px; max-width: 480px; margin: 0 auto; }

  /* â”€â”€ Alert Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .alerts-section { margin-bottom: 16px; }
  .alert-banner {
    border-radius: var(--radius); padding: 14px 16px;
    margin-bottom: 8px; display: flex; align-items: flex-start; gap: 12px;
    animation: slideIn 0.4s ease;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-8px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .alert-banner.critico {
    background: var(--crit-bg);
    border: 1.5px solid rgba(183,28,28,0.2);
    box-shadow: 0 2px 12px rgba(183,28,28,0.08);
  }
  .alert-banner.bajo {
    background: var(--low-bg);
    border: 1.5px solid rgba(230,81,0,0.2);
  }
  .alert-icon { font-size: 20px; flex-shrink: 0; margin-top: 1px; }
  .alert-content { flex: 1; }
  .alert-title { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
  .alert-banner.critico .alert-title { color: var(--crit); }
  .alert-banner.bajo .alert-title    { color: var(--low); }
  .alert-desc { font-size: 12px; color: var(--muted); line-height: 1.4; }

  /* â”€â”€ Section Label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .section-label {
    font-size: 11px; font-weight: 600; letter-spacing: 0.08em;
    text-transform: uppercase; color: var(--muted);
    margin: 20px 0 10px; display: flex; align-items: center; gap: 8px;
  }
  .section-label::after {
    content: ''; flex: 1; height: 1px; background: var(--border);
  }

  /* â”€â”€ Product Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .product-grid { display: flex; flex-direction: column; gap: 8px; }

  .product-card {
    background: var(--milk);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
    transition: transform 0.15s;
    animation: fadeUp 0.4s ease both;
  }
  .product-card:active { transform: scale(0.985); }

  .product-card.critico {
    border-color: rgba(183,28,28,0.25);
    background: #FFFAFA;
  }
  .product-card.bajo {
    border-color: rgba(230,81,0,0.2);
    background: #FFFDF8;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .card-top {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 10px;
  }
  .product-info { display: flex; align-items: center; gap: 10px; }
  .product-emoji { font-size: 20px; }
  .product-name { font-size: 14px; font-weight: 500; line-height: 1.2; }
  .product-type { font-size: 11px; color: var(--muted); margin-top: 1px; }

  .stock-value { text-align: right; }
  .stock-num {
    font-family: 'DM Serif Display', serif;
    font-size: 22px; line-height: 1; color: var(--roast);
  }
  .stock-num.critico { color: var(--crit); }
  .stock-num.bajo    { color: var(--low); }
  .stock-unit { font-size: 11px; color: var(--muted); margin-top: 2px; }

  /* Bar */
  .bar-track {
    height: 6px; background: var(--border); border-radius: 99px; overflow: hidden;
  }
  .bar-fill {
    height: 100%; border-radius: 99px;
    transition: width 0.8s cubic-bezier(.4,0,.2,1);
  }
  .bar-fill.ok     { background: linear-gradient(90deg, #388E3C, #66BB6A); }
  .bar-fill.bajo   { background: linear-gradient(90deg, #E65100, #FFA726); }
  .bar-fill.critico { background: linear-gradient(90deg, #B71C1C, #EF5350);
    animation: bar-pulse 2s ease-in-out infinite; }
  @keyframes bar-pulse {
    0%, 100% { opacity: 1; } 50% { opacity: 0.6; }
  }

  .card-footer {
    display: flex; align-items: center; justify-content: space-between;
    margin-top: 8px;
  }
  .status-badge {
    font-size: 10px; font-weight: 600; letter-spacing: 0.05em;
    padding: 3px 8px; border-radius: 99px;
  }
  .status-badge.ok     { background: var(--ok-bg); color: var(--ok); }
  .status-badge.bajo   { background: var(--low-bg); color: var(--low); }
  .status-badge.critico { background: var(--crit-bg); color: var(--crit); }

  .min-label { font-size: 10px; color: var(--muted); }

  /* â”€â”€ Pedido Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .pedido-card {
    background: var(--milk);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin-bottom: 8px;
    animation: fadeUp 0.4s ease both;
  }
  .pedido-header {
    padding: 12px 16px;
    background: var(--roast);
    display: flex; align-items: center; justify-content: space-between;
    cursor: pointer; user-select: none;
  }
  .pedido-header-left { display: flex; align-items: center; gap: 10px; }
  .pedido-header-icon { font-size: 18px; }
  .pedido-title { font-size: 14px; font-weight: 500; color: var(--cream); }
  .pedido-subtitle { font-size: 11px; color: var(--latte); margin-top: 1px; }
  .pedido-chevron {
    font-size: 12px; color: var(--latte);
    transition: transform 0.3s;
  }
  .pedido-card.open .pedido-chevron { transform: rotate(180deg); }

  .pedido-body {
    max-height: 0; overflow: hidden;
    transition: max-height 0.4s cubic-bezier(.4,0,.2,1);
  }
  .pedido-card.open .pedido-body { max-height: 1000px; }

  .pedido-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 16px; border-bottom: 1px solid var(--border);
  }
  .pedido-row:last-child { border-bottom: none; }
  .pedido-row-name { font-size: 13px; font-weight: 400; }
  .pedido-row-qty {
    font-size: 13px; font-weight: 600; color: var(--caramel);
    text-align: right;
  }
  .pedido-row-detail { font-size: 11px; color: var(--muted); }

  /* â”€â”€ Last Update Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .last-update {
    text-align: center; font-size: 11px; color: var(--muted);
    margin: 20px 0 8px; display: flex; align-items: center; justify-content: center; gap: 6px;
  }

  /* â”€â”€ Loading State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .loading-screen {
    position: fixed; inset: 0; background: var(--cream);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 16px;
    z-index: 999;
  }
  .loading-cup { font-size: 40px; animation: float 1.5s ease-in-out infinite; }
  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50%       { transform: translateY(-8px); }
  }
  .loading-text { font-size: 14px; color: var(--muted); }
  .loading-screen.hidden { display: none; }

  /* â”€â”€ Skeleton Loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .skeleton {
    background: linear-gradient(90deg, var(--border) 25%, #f3e9dd 50%, var(--border) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 6px;
  }
  @keyframes shimmer { to { background-position: -200% 0; } }

  /* â”€â”€ Error Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .error-banner {
    background: #FFF3E0; border: 1px solid #FFB74D;
    border-radius: var(--radius); padding: 14px 16px;
    font-size: 13px; color: #E65100; text-align: center;
    display: none;
  }
  .error-banner.show { display: block; }

  /* â”€â”€ Google Sheets info box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .config-box {
    background: var(--milk); border: 1px dashed var(--border);
    border-radius: var(--radius); padding: 14px 16px;
    font-size: 12px; color: var(--muted); line-height: 1.6;
  }
  .config-box strong { color: var(--mahogany); }
  .config-box code {
    background: var(--cream); padding: 2px 6px;
    border-radius: 4px; font-size: 11px; color: var(--roast);
  }
</style>
</head>
<body>

<!-- Loading -->
<div class="loading-screen" id="loading">
  <div class="loading-cup">â˜•</div>
  <div class="loading-text">Cargando stock...</div>
</div>

<!-- Header -->
<header>
  <div class="header-top">
    <div class="brand">
      <div class="brand-icon">â˜•</div>
      <div>
        <div class="brand-name">La Bolsa de CafÃ©</div>
        <div class="brand-sub">Control de Stock</div>
      </div>
    </div>
    <button class="refresh-btn" id="refreshBtn" onclick="loadData()" title="Actualizar">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 12a9 9 0 0 1 15-6.7L21 8M21 3v5h-5M21 12a9 9 0 0 1-15 6.7L3 16M3 21v-5h5"/>
      </svg>
    </button>
  </div>
  <div class="header-meta">
    <div class="dot live" id="statusDot"></div>
    <span id="headerDate">Cargando...</span>
  </div>
</header>

<main id="mainContent">
  <div class="error-banner" id="errorBanner">
    No se pudo cargar el stock. VerificÃ¡ tu conexiÃ³n e intentÃ¡ de nuevo.
  </div>
</main>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURACIÃ“N â€” Reemplazar con la URL real de Google Sheets
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Para conectar con Google Sheets:
// 1. Publicar la hoja ALERTAS_GENERADAS como CSV:
//    Archivo â†’ Compartir â†’ Publicar en la web â†’ elegir hoja â†’ CSV â†’ Publicar
// 2. Reemplazar SHEET_CSV_URL con la URL obtenida
// 3. El formato de la hoja debe tener columnas:
//    SKU | Nombre_Producto | Tipo_Producto | Stock_Actual | Stock_Minimo | Stock_Objetivo | Estado

const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRffHwJ6ENflfqZ54m0ehIjqAaJt5X-5-WCByHPuknvCzdbENe7hxMkL1DI2XWunZArFdmaDLg27VGE/pub?gid=1435082045&single=true&output=csv";
const REFRESH_INTERVAL_MS = 5 * 60 * 1000; // actualizar cada 5 minutos

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATOS DE DEMO â€” Se usan cuando no hay URL de Sheets configurada
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEMO_DATA = {
  fecha: "25/02/2026",
  ultimaActualizacion: new Date().toLocaleTimeString('es-AR', {hour:'2-digit',minute:'2-digit'}),
  productos: [
    // CafÃ©s
    { sku:"BARISTA",    nombre:"Barista",        tipo:"CafÃ©",    stockActual:17.8,  stockMin:4,    stockObj:15,   unidad:"kg",  emoji:"â˜•" },
    { sku:"MINKA",      nombre:"Minka",          tipo:"CafÃ©",    stockActual:0.68,  stockMin:1,    stockObj:6,    unidad:"kg",  emoji:"â˜•" },
    { sku:"SCEGLIERE",  nombre:"Scegliere",      tipo:"CafÃ©",    stockActual:1.25,  stockMin:0.75, stockObj:2.5,  unidad:"kg",  emoji:"â˜•" },
    { sku:"BRASIL",     nombre:"Brasil",         tipo:"CafÃ©",    stockActual:0.98,  stockMin:0.75, stockObj:3,    unidad:"kg",  emoji:"â˜•" },
    { sku:"COLOMBIA",   nombre:"Colombia",       tipo:"CafÃ©",    stockActual:1.21,  stockMin:0.75, stockObj:5,    unidad:"kg",  emoji:"â˜•" },
    { sku:"DESCAF",     nombre:"Descafeinado",   tipo:"CafÃ©",    stockActual:0.46,  stockMin:0.5,  stockObj:3,    unidad:"kg",  emoji:"â˜•" },
    // CÃ¡psulas
    { sku:"CAPS_BAR",   nombre:"CÃ¡p. Barista",   tipo:"CÃ¡psula", stockActual:4,     stockMin:5,    stockObj:100,  unidad:"u",   emoji:"âš«" },
    { sku:"CAPS_SCEGL", nombre:"CÃ¡p. Scegliere", tipo:"CÃ¡psula", stockActual:5,     stockMin:5,    stockObj:100,  unidad:"u",   emoji:"âš«" },
    { sku:"CAPS_COL",   nombre:"CÃ¡p. Colombia",  tipo:"CÃ¡psula", stockActual:6,     stockMin:5,    stockObj:100,  unidad:"u",   emoji:"âš«" },
    { sku:"CAPS_MINKA", nombre:"CÃ¡p. Minka",     tipo:"CÃ¡psula", stockActual:5,     stockMin:5,    stockObj:100,  unidad:"u",   emoji:"âš«" },
    // TÃ©s
    { sku:"TE_BOSTON",  nombre:"Te Boston",      tipo:"TÃ©",      stockActual:52,    stockMin:20,   stockObj:100,  unidad:"u",   emoji:"ğŸ«–" },
    { sku:"TE_BOLDO",   nombre:"Te Boldo",       tipo:"TÃ©",      stockActual:100,   stockMin:20,   stockObj:100,  unidad:"u",   emoji:"ğŸ«–" },
    { sku:"TE_VERDE",   nombre:"Te Verde",       tipo:"TÃ©",      stockActual:35,    stockMin:20,   stockObj:100,  unidad:"u",   emoji:"ğŸ«–" },
    { sku:"TE_CACHAMAI",nombre:"Te Cachamai",    tipo:"TÃ©",      stockActual:56,    stockMin:20,   stockObj:100,  unidad:"u",   emoji:"ğŸ«–" },
    { sku:"TE_NATURA",  nombre:"Te Natura",      tipo:"TÃ©",      stockActual:70,    stockMin:20,   stockObj:100,  unidad:"u",   emoji:"ğŸ«–" },
  ],
  recomendaciones: [
    { nombre:"CafÃ© Barista",       cantidad:"No requiere",  detalle:"" },
    { nombre:"CafÃ© Minka",         cantidad:"5.3 kg",       detalle:"22 bolsas" },
    { nombre:"CafÃ© Scegliere",     cantidad:"1.3 kg",       detalle:"6 bolsas" },
    { nombre:"CafÃ© Brasil",        cantidad:"2.0 kg",       detalle:"8 bolsas" },
    { nombre:"CafÃ© Colombia",      cantidad:"3.8 kg",       detalle:"16 bolsas" },
    { nombre:"CafÃ© Descafeinado",  cantidad:"2.5 kg",       detalle:"10 bolsas" },
    { nombre:"CÃ¡ps. Barista",      cantidad:"96 u",         detalle:"10 cajas" },
    { nombre:"CÃ¡ps. Scegliere",    cantidad:"95 u",         detalle:"10 cajas" },
    { nombre:"CÃ¡ps. Colombia",     cantidad:"94 u",         detalle:"10 cajas" },
    { nombre:"CÃ¡ps. Minka",        cantidad:"95 u",         detalle:"10 cajas" },
  ]
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILIDADES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getEstado(actual, min, obj) {
  if (actual <= min) return "critico";
  if (actual <= min * 1.5) return "bajo";
  return "ok";
}

function getBarPct(actual, obj) {
  return Math.min(100, Math.round((actual / obj) * 100));
}

function fmtStock(val, unit) {
  if (unit === "kg") {
    return val < 1 ? `${(val*1000).toFixed(0)}` : `${val.toFixed(1)}`;
  }
  return val.toFixed(0);
}

function fmtUnit(val, unit) {
  if (unit === "kg") return val < 1 ? "g" : "kg";
  return unit;
}

function staggerDelay(i) {
  return `animation-delay: ${i * 0.04}s`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSEAR CSV DE GOOGLE SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseCSV(csv) {
  const lines = csv.trim().split("\n");
  const headers = lines[0].split(",").map(h => h.trim().replace(/"/g,''));
  return lines.slice(1).map(line => {
    // Split respetando comas dentro de comillas
    const vals = [];
    let cur = '', inQ = false;
    for (const ch of line) {
      if (ch === '"') { inQ = !inQ; }
      else if (ch === ',' && !inQ) { vals.push(cur.trim()); cur = ''; }
      else { cur += ch; }
    }
    vals.push(cur.trim());
    const obj = {};
    headers.forEach((h, i) => obj[h] = (vals[i] || "").replace(/"/g,''));
    return obj;
  }).filter(r => r.SKU && r.SKU.trim() !== '');
}

function inferTipo(sku) {
  if (sku.startsWith("CAPS_")) return "CAPSULA";
  if (sku.startsWith("TE_"))   return "TE";
  return "CAFE";
}

function parseEstado(estadoStr) {
  const s = estadoStr.toUpperCase();
  if (s.includes("CRITICO") || s.includes("CRÃTICO")) return "critico";
  if (s.includes("BAJO"))    return "bajo";
  return "ok";
}

function sheetsToProductos(rows) {
  return rows.map(r => {
    const tipo   = inferTipo(r.SKU || "");
    const emoji  = tipo === "CAFE" ? "â˜•" : tipo === "CAPSULA" ? "âš«" : "ğŸ«–";
    const unidad = tipo === "CAFE" ? "kg" : "u";

    // Stock en gramos para cafÃ©s â†’ convertir a kg
    let stockActual = parseFloat((r.Stock_Actual || "0").replace(",",".")) || 0;
    let stockMin    = parseFloat((r.Stock_Minimo  || "0").replace(",",".")) || 0;
    if (tipo === "CAFE") { stockActual = stockActual / 1000; stockMin = stockMin / 1000; }

    // Stock objetivo no estÃ¡ en la hoja â†’ mÃ­nimo * 3
    const stockObj = Math.max(stockMin * 3, 0.01);

    // Estado directo de la columna (tiene emojis, parseamos el texto)
    const estado = parseEstado(r.Estado || "");

    const nombre = (r.Nombre_Producto || r.SKU || "").trim();

    return { sku: r.SKU, nombre, tipo, stockActual, stockMin, stockObj, unidad, emoji, estado };
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(data) {
  const container = document.getElementById('mainContent');
  container.innerHTML = '';

  // â”€â”€ Alertas crÃ­ticas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Usar el estado directo del objeto (viene de Sheets o calculado)
  const criticos = data.productos.filter(p => (p.estado || getEstado(p.stockActual, p.stockMin, p.stockObj)) === "critico");
  const bajos    = data.productos.filter(p => (p.estado || getEstado(p.stockActual, p.stockMin, p.stockObj)) === "bajo");

  if (criticos.length > 0 || bajos.length > 0) {
    const sec = document.createElement('div');
    sec.className = 'alerts-section';

    criticos.forEach(p => {
      const def = p.stockMin - p.stockActual;
      const defStr = p.unidad === 'kg'
        ? (def < 0.1 ? `${(def*1000).toFixed(0)}g` : `${def.toFixed(2)}kg`)
        : `${def.toFixed(0)} ${p.unidad}`;
      sec.innerHTML += `
        <div class="alert-banner critico">
          <div class="alert-icon">âš ï¸</div>
          <div class="alert-content">
            <div class="alert-title">Stock crÃ­tico: ${p.nombre}</div>
            <div class="alert-desc">Faltan ${defStr} para el mÃ­nimo Â· Hacer pedido urgente</div>
          </div>
        </div>`;
    });

    bajos.forEach(p => {
      sec.innerHTML += `
        <div class="alert-banner bajo">
          <div class="alert-icon">âš¡</div>
          <div class="alert-content">
            <div class="alert-title">Stock bajo: ${p.nombre}</div>
            <div class="alert-desc">Cerca del mÃ­nimo Â· Incluir en prÃ³ximo pedido</div>
          </div>
        </div>`;
    });
    container.appendChild(sec);
  }

  // â”€â”€ Productos por tipo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const tipos = [...new Set(data.productos.map(p => p.tipo))];
  const tipoLabels = { CAFE:"CafÃ©s", CAPSULA:"CÃ¡psulas", TE:"TÃ©s", undefined:"Otros" };
  const tipoEmojis = { CAFE:"â˜•", CAPSULA:"âš«", TE:"ğŸ«–" };

  let cardIdx = 0;
  tipos.forEach(tipo => {
    const prods = data.productos.filter(p => p.tipo === tipo);
    if (!prods.length) return;

    const label = document.createElement('div');
    label.className = 'section-label';
    label.textContent = tipoLabels[tipo] || tipo;
    container.appendChild(label);

    const grid = document.createElement('div');
    grid.className = 'product-grid';

    prods.forEach(p => {
      const estado = p.estado || getEstado(p.stockActual, p.stockMin, p.stockObj);
      const pct    = getBarPct(p.stockActual, p.stockObj);
      const val    = fmtStock(p.stockActual, p.unidad);
      const unit   = fmtUnit(p.stockActual, p.unidad);
      const minStr = p.unidad === 'kg'
        ? (p.stockMin < 1 ? `${(p.stockMin*1000).toFixed(0)}g` : `${p.stockMin}kg`)
        : `${p.stockMin} ${p.unidad}`;
      const estadoLabel = { ok:"OK", bajo:"Bajo", critico:"CrÃ­tico" }[estado];

      const card = document.createElement('div');
      card.className = `product-card ${estado}`;
      card.style.cssText = staggerDelay(cardIdx++);
      card.innerHTML = `
        <div class="card-top">
          <div class="product-info">
            <div class="product-emoji">${p.emoji}</div>
            <div>
              <div class="product-name">${p.nombre}</div>
              <div class="product-type">${tipoLabels[tipo] || tipo}</div>
            </div>
          </div>
          <div class="stock-value">
            <div class="stock-num ${estado}">${val}</div>
            <div class="stock-unit">${unit}</div>
          </div>
        </div>
        <div class="bar-track">
          <div class="bar-fill ${estado}" style="width:${pct}%"></div>
        </div>
        <div class="card-footer">
          <span class="status-badge ${estado}">${estadoLabel}</span>
          <span class="min-label">MÃ­nimo: ${minStr}</span>
        </div>`;
      grid.appendChild(card);
    });
    container.appendChild(grid);
  });

  // â”€â”€ RecomendaciÃ³n de pedido â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (data.recomendaciones && data.recomendaciones.length > 0) {
    const label2 = document.createElement('div');
    label2.className = 'section-label';
    label2.textContent = 'PrÃ³ximo pedido';
    container.appendChild(label2);

    const pedCard = document.createElement('div');
    pedCard.className = 'pedido-card';
    pedCard.id = 'pedidoCard';

    const recsConCantidad = data.recomendaciones.filter(r => r.cantidad && r.cantidad !== "No requiere");
    const proxEntrega = getNextDelivery();

    let rowsHTML = recsConCantidad.map(r => `
      <div class="pedido-row">
        <div>
          <div class="pedido-row-name">${r.nombre}</div>
          ${r.detalle ? `<div class="pedido-row-detail">${r.detalle}</div>` : ''}
        </div>
        <div class="pedido-row-qty">${r.cantidad}</div>
      </div>`).join('');

    if (!rowsHTML) {
      rowsHTML = `<div class="pedido-row"><div class="pedido-row-name" style="color:var(--ok)">âœ… Todo en buen stock. No se requiere pedido ahora.</div></div>`;
    }

    pedCard.innerHTML = `
      <div class="pedido-header" onclick="togglePedido()">
        <div class="pedido-header-left">
          <div class="pedido-header-icon">ğŸ“¦</div>
          <div>
            <div class="pedido-title">RecomendaciÃ³n de pedido</div>
            <div class="pedido-subtitle">Entrega estimada: ${proxEntrega}</div>
          </div>
        </div>
        <div class="pedido-chevron">â–¼</div>
      </div>
      <div class="pedido-body">${rowsHTML}</div>`;
    container.appendChild(pedCard);
  }

  // â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const footer = document.createElement('div');
  footer.className = 'last-update';
  const isDemo = !SHEET_CSV_URL;
  footer.innerHTML = isDemo
    ? `<span>âš ï¸ Modo demo Â· <a href="#config" style="color:var(--caramel)">Conectar Google Sheets</a></span>`
    : `<span>Actualizado: ${data.ultimaActualizacion} Â· Datos: ${data.fecha}</span>`;
  container.appendChild(footer);

  if (isDemo) {
    const configBox = document.createElement('div');
    configBox.className = 'config-box';
    configBox.innerHTML = `
      <strong>Para conectar con tus datos reales:</strong><br><br>
      1. En Google Sheets â†’ <strong>Archivo â†’ Compartir â†’ Publicar en la web</strong><br>
      2. SeleccionÃ¡ la hoja <code>ALERTAS_GENERADAS</code> â†’ formato <code>CSV</code> â†’ Publicar<br>
      3. CopiÃ¡ la URL y pegala en la variable <code>SHEET_CSV_URL</code> al inicio del cÃ³digo<br><br>
      <strong>Columnas requeridas:</strong> SKU, Nombre_Producto, Tipo_Producto, Stock_Actual, Stock_Minimo, Stock_Objetivo, Estado
    `;
    container.appendChild(configBox);
  }

  // Update header
  document.getElementById('headerDate').textContent = `${data.fecha} Â· DÃ­a registrado: ${data.fecha}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getNextDelivery() {
  const today = new Date();
  const day = today.getDay(); // 0=dom, 1=lun, ..., 4=jue, 5=vie
  // Pedidos lunes y jueves â†’ entregan martes y viernes
  let daysUntil;
  if (day <= 1) daysUntil = 2 - day;       // martes
  else if (day <= 4) daysUntil = 5 - day;  // viernes
  else daysUntil = 9 - day;                // prÃ³ximo martes
  const delivery = new Date(today);
  delivery.setDate(today.getDate() + daysUntil);
  return delivery.toLocaleDateString('es-AR', { weekday:'long', day:'numeric', month:'short' });
}

function togglePedido() {
  const card = document.getElementById('pedidoCard');
  if (card) card.classList.toggle('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARGA DE DATOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadData() {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('spinning');

  try {
    if (SHEET_CSV_URL) {
      // Fetch desde Google Sheets publicado como CSV
      const resp = await fetch(SHEET_CSV_URL);
      if (!resp.ok) throw new Error("Error al cargar Sheets");
      const csv = await resp.text();
      const rows = parseCSV(csv);
      const productos = sheetsToProductos(rows);
      renderDashboard({
        fecha: new Date().toLocaleDateString('es-AR'),
        ultimaActualizacion: new Date().toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'}),
        productos,
        recomendaciones: [] // La recomendaciÃ³n vendrÃ­a de otra hoja
      });
    } else {
      // Modo demo con datos hardcodeados
      await new Promise(r => setTimeout(r, 600)); // simular latencia
      renderDashboard(DEMO_DATA);
    }
    document.getElementById('errorBanner').classList.remove('show');
    document.getElementById('statusDot').classList.add('live');
  } catch(err) {
    console.error(err);
    document.getElementById('errorBanner').classList.add('show');
    document.getElementById('statusDot').classList.remove('live');
  } finally {
    btn.classList.remove('spinning');
    document.getElementById('loading').classList.add('hidden');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadData();
setInterval(loadData, REFRESH_INTERVAL_MS);
</script>
</body>
</html>
